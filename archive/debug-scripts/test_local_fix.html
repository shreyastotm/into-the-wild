<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Trek Loading Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test Trek Loading Fix</h1>
    <p>This page tests the trek loading fixes without authentication issues.</p>
    
    <div class="test-section info">
        <h3>Test 1: Check Events Loading</h3>
        <p>This will test if the events page can load treks with the new filtering logic.</p>
        <button onclick="testEventsLoading()">Test Events Loading</button>
        <div id="events-result"></div>
    </div>
    
    <div class="test-section info">
        <h3>Test 2: Check Past Treks Logic</h3>
        <p>This will test if past treks are properly identified with the new status logic.</p>
        <button onclick="testPastTreksLogic()">Test Past Treks Logic</button>
        <div id="past-treks-result"></div>
    </div>
    
    <div class="test-section info">
        <h3>Test 3: Direct Database Query</h3>
        <p>This will test the exact database queries used by the application.</p>
        <button onclick="testDatabaseQueries()">Test Database Queries</button>
        <div id="database-result"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://lojnpkunoufmwwcifwan.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxvam5wa3Vub3VmbXd3Y2lmd2FuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzMDcyMTMsImV4cCI6MjA1OTg4MzIxM30.MullqAvDPGgkDc3yW-GIuenn87U-Z3KLDmpU6U1BJmU';
        
        // Create Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        async function testEventsLoading() {
            const resultDiv = document.getElementById('events-result');
            resultDiv.innerHTML = '<p>Testing events loading...</p>';
            
            try {
                // Test the exact query from TrekEvents.tsx
                const selectString = 'trek_id,name,description,category,base_price,start_datetime,max_participants,image_url,image,location,status,duration,cancellation_policy,event_creator_type,transport_mode,event_type';
                let query = supabaseClient.from('trek_events').select(selectString);
                
                // Apply the fixed filtering (only exclude Cancelled)
                query = query.neq('status', 'Cancelled');
                
                // Apply future date filter (like the events page does)
                query = query.gte('start_datetime', new Date().toISOString());
                
                const { data, error } = await query;
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error"><h4>Error:</h4><pre>${JSON.stringify(error, null, 2)}</pre></div>`;
                } else {
                    resultDiv.innerHTML = `<div class="success">
                        <h4>Success! Found ${data?.length || 0} events</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h4>Exception:</h4><pre>${error.message}</pre></div>`;
            }
        }
        
        async function testPastTreksLogic() {
            const resultDiv = document.getElementById('past-treks-result');
            resultDiv.innerHTML = '<p>Testing past treks logic...</p>';
            
            try {
                // Get all events with status
                const { data: allEvents, error } = await supabaseClient
                    .from('trek_events')
                    .select('trek_id, name, start_datetime, status');
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error"><h4>Error:</h4><pre>${JSON.stringify(error, null, 2)}</pre></div>`;
                    return;
                }
                
                const now = new Date();
                const pastTreks = allEvents?.filter(event => {
                    const startDate = new Date(event.start_datetime);
                    return startDate < now || 
                           event.status === 'Completed' || 
                           event.status === 'Archived';
                }) || [];
                
                resultDiv.innerHTML = `<div class="success">
                    <h4>Past Treks Logic Test</h4>
                    <p>Total events: ${allEvents?.length || 0}</p>
                    <p>Past treks identified: ${pastTreks.length}</p>
                    <pre>${JSON.stringify(pastTreks, null, 2)}</pre>
                </div>`;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h4>Exception:</h4><pre>${error.message}</pre></div>`;
            }
        }
        
        async function testDatabaseQueries() {
            const resultDiv = document.getElementById('database-result');
            resultDiv.innerHTML = '<p>Testing database queries...</p>';
            
            try {
                // Test 1: Events page query
                const { data: eventsData, error: eventsError } = await supabaseClient
                    .from('trek_events')
                    .select('trek_id, name, status, start_datetime')
                    .neq('status', 'Cancelled')
                    .gte('start_datetime', new Date().toISOString());
                
                // Test 2: Past treks query
                const { data: pastData, error: pastError } = await supabaseClient
                    .from('trek_events')
                    .select('trek_id, name, status, start_datetime')
                    .or('start_datetime.lt.' + new Date().toISOString() + ',status.eq.Completed,status.eq.Archived');
                
                resultDiv.innerHTML = `<div class="success">
                    <h4>Database Query Results</h4>
                    <h5>Events Page Query (Future Events):</h5>
                    <p>Count: ${eventsData?.length || 0}</p>
                    <pre>${JSON.stringify(eventsData, null, 2)}</pre>
                    
                    <h5>Past Treks Query:</h5>
                    <p>Count: ${pastData?.length || 0}</p>
                    <pre>${JSON.stringify(pastData, null, 2)}</pre>
                </div>`;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><h4>Exception:</h4><pre>${error.message}</pre></div>`;
            }
        }
    </script>
    
    <!-- Include Supabase client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>
